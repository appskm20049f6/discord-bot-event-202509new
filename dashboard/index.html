<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Discord Bot 後台管理</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background: #f4f4f4; }
    .container { display: flex; height: 100vh; }
    .sidebar { width: 270px; background: #222; color: #fff; padding-top: 40px; border-radius: 24px; box-shadow: 0 6px 24px #0002; margin: 24px 0 24px 24px; display: flex; flex-direction: column; align-items: stretch; }
    .sidebar h3 { text-align:center; margin-bottom:32px; font-size:20px; letter-spacing:2px; }
    .card-select {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 16px #0003;
      padding: 28px 18px 24px 18px;
      margin: 0 0 32px 0;
      display: flex;
      flex-direction: column;
      gap: 22px;
      align-items: stretch;
      box-sizing: border-box;
    }
    .select-group { display: flex; flex-direction: column; gap: 10px; }
    .select-group label { font-weight: bold; color: #333; font-size: 16px; }
    .select-box, #channelSearch {
      width: 100%; min-width: 0; max-width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid #ccc; font-size: 17px; background: #f8f8f8; box-sizing: border-box; margin: 0; display: block;
    }
    .sidebar .menu { list-style:none; padding:0; margin-top:24px; }
    .sidebar .menu li { padding:18px 28px; cursor:pointer; font-size:17px; border-radius:8px; margin-bottom:8px; transition:background 0.2s; }
    .sidebar .menu li.active, .sidebar .menu li:hover { background:#007bff; color:#fff; }
    .main { flex:1; background:#fff; padding:48px 64px; overflow:auto; border-radius:24px; margin:24px; box-shadow:0 6px 24px #0001; min-width:400px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="card-select">
        <div class="select-group">
          <label for="guilds">選擇DC伺服器</label>
          <select id="guilds" class="select-box"></select>
        </div>
        <div class="select-group">
          <label for="channels">選擇發布頻道</label>
          <input id="channelSearch" class="select-box" type="text" placeholder="搜尋頻道名稱..." />
          <select id="channels" class="select-box"></select>
        </div>
      </div>
      <h3>管理工具</h3>
      <ul class="menu">
        <li id="menu-lottery" class="active" onclick="loadPage('lottery')">抽獎</li>
        <li id="menu-vote" onclick="loadPage('vote')">投票</li>
      </ul>
    </div>
    <div class="main" id="main-content">
      <h2 style="margin-top:0;">歡迎使用 Discord Bot 後台管理系統</h2>
      <p>請從左側選單選擇功能分頁。</p>
    </div>
  </div>
  <script>
    // 載入伺服器選單
    fetch('/api/guilds')
      .then(res => res.json())
      .then(guilds => {
        const guildSel = document.getElementById('guilds');
        guildSel.innerHTML = '';
        guilds.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.id;
          opt.textContent = g.name;
          guildSel.appendChild(opt);
        });
        if (guilds.length) loadChannels(guilds[0].id);
      });
    document.getElementById('guilds').onchange = e => {
      loadChannels(e.target.value);
    };
    let allChannels = [];
    function loadChannels(guildId) {
      fetch(`/api/guilds/${guildId}/channels`)
        .then(res => res.json())
        .then(channels => {
          allChannels = channels;
          renderChannelOptions('');
        });
    }
    function renderChannelOptions(keyword) {
      const chSel = document.getElementById('channels');
      chSel.innerHTML = '';
      const filtered = allChannels.filter(ch => ch.name.toLowerCase().includes(keyword.toLowerCase()));
      filtered.forEach(ch => {
        const opt = document.createElement('option');
        opt.value = ch.id;
        opt.textContent = ch.name;
        chSel.appendChild(opt);
      });
    }
    document.getElementById('channelSearch').addEventListener('input', e => {
      renderChannelOptions(e.target.value);
    });
    // 單頁式分頁切換
    function loadPage(page) {
      document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
      document.getElementById('menu-' + page).classList.add('active');
      fetch('/dashboard/' + page + '.html')
        .then(res => res.text())
        .then(html => {
          document.getElementById('main-content').innerHTML = html;
          if (page === 'lottery') initLottery();
          if (page === 'vote') initVote();
        });
    }
    // 分頁 JS 集中於主頁
    function initLottery() {
      // 初始化抽獎分頁互動
      window.submitLottery = function() {
        const title = document.getElementById('lotteryTitle').value;
        const answer = document.getElementById('lotteryAnswer').value;
        const time = document.getElementById('lotteryTime').value;
        const winnerCount = document.getElementById('lotteryWinnerCount').value;
        const options = ['optionA','optionB','optionC','optionD'].map(n => document.getElementsByName(n)[0].value.trim()).filter(Boolean);
        const channelId = document.getElementById('channels')?.value;
        if (!channelId) {
          document.getElementById('lotteryCreateResult').textContent = '⚠️ 請先選擇發布頻道';
          return;
        }
        fetch('/api/start-lottery-event', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: title,
            options,
            answer,
            countdown: Number(time),
            winners: Number(winnerCount),
            channelId
          })
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            document.getElementById('lotteryCreateResult').textContent = '✅ 抽獎活動已發布！';
            document.getElementById('lotteryForm').reset();
            loadLotteryList();
          } else {
            document.getElementById('lotteryCreateResult').textContent = '❌ 發布失敗：' + (result.error || '未知錯誤');
          }
        });
      };
      window.loadLotteryList = function() {
        fetch('/api/lottery')
          .then(res => res.json())
          .then(list => {
            document.getElementById('lotteryList').innerHTML =
              list.map(item => `<div>活動：${item.name}</div>`).join('');
          })
          .catch(err => {
            document.getElementById('lotteryList').innerHTML = `⚠️ 載入失敗：${err.message}`;
          });
      };
    }
    function initVote() {
      // 初始化投票分頁互動
      window.createVote = function() {
        alert('這裡可以彈出新建投票的表單');
      };
      fetch('/api/vote')
        .then(res => res.json())
        .then(list => {
          document.getElementById('voteList').innerHTML =
            list.map(item => `<div>投票：${item.name}</div>`).join('');
        });
    }
    // 預設載入抽獎分頁
    loadPage('lottery');
  </script>
</body>
</html>
